{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}GymEdge{% endblock %} | GymEdge SaaS</title>
    <meta name="description" content="AI-powered gym management platform">
    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">

    <!-- Google Font (dynamic per gym) -->
    {% with gym_font=request.user.gym.font_family|default:"Inter" %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family={{ gym_font }}:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    {% endwith %}

    <!-- Tailwind CSS v3 CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // ── Dynamic Brand Color Palette Generator ────────────
        // Converts a single hex color → full 50-950 Tailwind palette via HSL math
        function hexToHSL(hex) {
            let r = parseInt(hex.slice(1,3),16)/255;
            let g = parseInt(hex.slice(3,5),16)/255;
            let b = parseInt(hex.slice(5,7),16)/255;
            let max = Math.max(r,g,b), min = Math.min(r,g,b);
            let h, s, l = (max+min)/2;
            if (max===min) { h=s=0; }
            else {
                let d = max-min;
                s = l>0.5 ? d/(2-max-min) : d/(max+min);
                switch(max) {
                    case r: h=((g-b)/d+(g<b?6:0))/6; break;
                    case g: h=((b-r)/d+2)/6; break;
                    case b: h=((r-g)/d+4)/6; break;
                }
            }
            return [Math.round(h*360), Math.round(s*100), Math.round(l*100)];
        }

        function generatePalette(hex) {
            const [h, s] = hexToHSL(hex);
            return {
                50:  `hsl(${h}, ${Math.min(s+10,100)}%, 97%)`,
                100: `hsl(${h}, ${Math.min(s+8,100)}%, 94%)`,
                200: `hsl(${h}, ${Math.min(s+5,100)}%, 86%)`,
                300: `hsl(${h}, ${s}%, 75%)`,
                400: `hsl(${h}, ${s}%, 62%)`,
                500: `hsl(${h}, ${s}%, ${hexToHSL(hex)[2]}%)`,
                600: `hsl(${h}, ${s}%, ${Math.max(hexToHSL(hex)[2]-8, 20)}%)`,
                700: `hsl(${h}, ${s}%, ${Math.max(hexToHSL(hex)[2]-16, 15)}%)`,
                800: `hsl(${h}, ${Math.max(s-5,0)}%, ${Math.max(hexToHSL(hex)[2]-24, 12)}%)`,
                900: `hsl(${h}, ${Math.max(s-10,0)}%, ${Math.max(hexToHSL(hex)[2]-32, 10)}%)`,
                950: `hsl(${h}, ${Math.max(s-10,0)}%, ${Math.max(hexToHSL(hex)[2]-40, 6)}%)`,
            };
        }

        // Get brand color from Django template or use default indigo
        const brandHex = '{{ request.user.gym.brand_color|default:"#6366f1" }}';
        const palette = generatePalette(brandHex);
        const gymFont = '{{ request.user.gym.font_family|default:"Inter" }}';

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: [gymFont, 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        brand: palette,
                    }
                }
            }
        }
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4" integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+" crossorigin="anonymous"></script>

    <!-- Alpine.js for interactive components -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Custom styles -->
    <style>
        /* HTMX loading indicator */
        .htmx-indicator { opacity: 0; transition: opacity 300ms ease-in; }
        .htmx-request .htmx-indicator, .htmx-request.htmx-indicator { opacity: 1; }

        /* Smooth transitions */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Toast animation */
        .toast-enter { animation: slideInRight 0.3s ease-out; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen font-sans" x-data="{ sidebarOpen: false }">

    {% if user.is_authenticated %}
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        {% include "components/sidebar.html" %}

        <!-- Main content area -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Topbar -->
            {% include "components/topbar.html" %}

            <!-- Page content -->
            <main class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8">
                <!-- Toast messages -->
                <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

                <!-- Breadcrumb -->
                {% block breadcrumb %}{% endblock %}

                <!-- Page content -->
                <div class="fade-in">
                    {% block content %}{% endblock %}
                </div>
            </main>
        </div>
    </div>
    {% else %}
    <!-- Public/Auth Pages -->
    <div class="min-h-screen flex flex-col bg-slate-950">
        <!-- Public Header -->
        {% include "components/public_header.html" %}

        <!-- Main Content -->
        <main class="flex-1 flex items-center justify-center pt-20 pb-10 px-4 relative">
            <!-- Background effects for auth pages -->
            <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
                <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-indigo-600/10 rounded-full blur-3xl opacity-50"></div>
                <div class="absolute bottom-1/4 right-1/4 w-80 h-80 bg-cyan-600/10 rounded-full blur-3xl opacity-50"></div>
            </div>
            
            <div class="relative z-10 w-full max-w-md">
                {% block auth_content %}{% endblock %}
            </div>
        </main>

        <!-- Public Footer -->
        <!-- Only show footer on auth pages if desired, or keep it sticky at bottom -->
        {% include "components/public_footer.html" %}
    </div>
    {% endif %}

    <!-- HTMX config -->
    <script>
        document.body.addEventListener('htmx:afterSwap', function(e) {
            // Auto-dismiss toasts after 4 seconds
            if (e.detail.target.id === 'toast-container') {
                setTimeout(() => {
                    const toast = e.detail.target.firstElementChild;
                    if (toast) toast.remove();
                }, 4000);
            }
        });

        // Show loading overlay on page transitions
        document.body.addEventListener('htmx:beforeRequest', function(e) {
            if (e.detail.elt.hasAttribute('hx-indicator')) return;
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
