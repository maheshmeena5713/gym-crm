{% extends "base.html" %}
{% load static %}
{% block title %}Start Free Trial - GymEdge{% endblock %}

{% block auth_content %}
<div class="w-full">
    <!-- Header Text -->
    <div class="text-center mb-8">
         <h1 class="text-3xl font-bold text-white mb-2">Start Your Free Trial</h1>
         <p class="text-slate-400">14 days free. No credit card required.</p>
    </div>

    <!-- Progress Steps -->
    <div class="flex items-center justify-center gap-3 mb-8">
        <div id="dot-1" class="step-dot active w-3 h-3 rounded-full bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-all"></div>
        <div class="w-8 h-0.5 bg-slate-700/50"></div>
        <div id="dot-2" class="step-dot w-3 h-3 rounded-full bg-slate-800 transition-all"></div>
        <div class="w-8 h-0.5 bg-slate-700/50"></div>
        <div id="dot-3" class="step-dot w-3 h-3 rounded-full bg-slate-800 transition-all"></div>
        <div class="w-8 h-0.5 bg-slate-700/50"></div>
        <div id="dot-4" class="step-dot w-3 h-3 rounded-full bg-slate-800 transition-all"></div>
    </div>

    <!-- Signup Card -->
    <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-xl rounded-3xl p-8 shadow-2xl shadow-indigo-500/5 relative">
        
        <!-- Step 1: Choose Plan -->
        <div id="step-1" class="space-y-4">
            <h2 class="text-lg font-semibold text-white mb-4">Choose Your Plan</h2>
            <div class="space-y-3">
                {% for plan in plans %}
                <label class="relative block cursor-pointer group">
                    <input type="radio" name="plan_slug" value="{{ plan.slug }}" class="peer sr-only" {% if selected_plan == plan.slug %}checked{% endif %}>
                    <div class="p-4 rounded-xl border border-slate-700 bg-slate-800/30 peer-checked:border-indigo-500 peer-checked:bg-indigo-500/10 hover:border-slate-500 transition-all">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-white">{{ plan.name }}</span>
                            <span class="text-indigo-400 font-semibold">₹{{ plan.price_monthly|floatformat:0 }}/mo</span>
                        </div>
                        <p class="text-sm text-slate-400">Up to {{ plan.max_members }} members.</p>
                    </div>
                </label>
                {% endfor %}
            </div>
            <button onclick="goToStep2()" 
                    class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-indigo-500/20 mt-4">
                Continue <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>

        <!-- Step 2: Gym Details -->
        <div id="step-2" class="space-y-4 hidden">
            <h2 class="text-lg font-semibold text-white mb-4">Gym Details</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Gym Name</label>
                    <input type="text" id="gym_name" placeholder="e.g. FitZone"
                           oninput="suggestUsername()"
                           class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white placeholder-slate-600 focus:outline-none focus:border-indigo-500 transition-all">
                </div>
                
                <div class="col-span-2">
                    <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">City</label>
                    <input type="text" id="city" placeholder="City"
                           class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white placeholder-slate-600 focus:outline-none focus:border-indigo-500 transition-all">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="goBack(1)" class="px-6 py-3.5 bg-slate-800 hover:bg-slate-700 text-white font-medium rounded-xl transition-all">
                    Back
                </button>
                <button onclick="goToStep3()" 
                        class="flex-1 py-3.5 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-indigo-500/20">
                    Continue <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
        <!-- Step 3: Owner Details -->
        <div id="step-3" class="space-y-4 hidden">
            <h2 class="text-lg font-semibold text-white mb-4">Owner Profile</h2>
            
            <div>
                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Owner Name</label>
                <input type="text" id="owner_name" placeholder="Name"
                       oninput="suggestUsername()"
                       class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white placeholder-slate-600 focus:outline-none focus:border-indigo-500 transition-all">
            </div>

            <div>
                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Email</label>
                <input type="email" id="email" placeholder="you@example.com"
                       class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white placeholder-slate-600 focus:outline-none focus:border-indigo-500 transition-all">
            </div>

            <!-- Username -->
            <div>
                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Username</label>
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-medium">@</span>
                    <input type="text" id="username" placeholder="username"
                           oninput="onUsernameInput(this)"
                           class="w-full pl-9 pr-10 py-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white placeholder-slate-600 focus:outline-none focus:border-indigo-500 transition-all">
                    <span id="username-icon" class="absolute right-3 top-1/2 -translate-y-1/2 text-lg hidden"></span>
                </div>
                <p id="username-status" class="text-xs mt-1.5 h-4"></p>
            </div>

            <!-- Password -->
            <div>
                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Password</label>
                <div class="relative">
                    <input type="password" id="signup_password" placeholder="••••••••"
                           class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white placeholder-slate-600 focus:outline-none focus:border-indigo-500 transition-all pr-10">
                    <button type="button" onclick="toggleSignupPw()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white">
                        <i data-lucide="eye" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="goBack(2)" class="px-6 py-3.5 bg-slate-800 hover:bg-slate-700 text-white font-medium rounded-xl transition-all">
                    Back
                </button>
                <button onclick="goToStep4()" 
                        class="flex-1 py-3.5 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-indigo-500/20">
                    Continue <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- Step 4: Phone & OTP -->
        <div id="step-4" class="space-y-6 hidden">
            <h2 class="text-lg font-semibold text-white mb-2">Verify Phone</h2>
            <p class="text-sm text-slate-400 -mt-4 mb-6">We'll send an OTP to verify your account.</p>

            <div>
                <label class="block text-xs font-medium text-slate-400 mb-1.5 uppercase tracking-wide">Phone Number</label>
                <div class="flex items-center gap-2">
                    <span class="px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-slate-300 font-medium">+91</span>
                    <input type="tel" id="phone" placeholder="9876543210" maxlength="10"
                           class="flex-1 px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white placeholder-slate-600 focus:outline-none focus:border-indigo-500 transition-all">
                </div>
            </div>

            <div id="otp-error" class="hidden bg-red-500/10 border border-red-500/20 text-red-400 text-sm p-4 rounded-xl"></div>

            <button onclick="sendOTP()" id="btn-send-otp"
                    class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-indigo-500/20">
                <span id="send-otp-text">Send OTP</span>
                <i data-lucide="send" class="w-4 h-4"></i>
            </button>

            <button onclick="goBack(3)" class="w-full text-slate-500 hover:text-white text-sm py-2">Back to profile</button>
        </div>

        <!-- Step 5: Verify OTP -->
        <div id="step-5" class="space-y-6 hidden">
            <h2 class="text-lg font-semibold text-white mb-2">Enter OTP</h2>
            <p class="text-sm text-slate-400 -mt-4">Sent to <span id="show-phone" class="text-white"></span></p>
            
            <div>
                 <input type="text" id="otp" placeholder="000000" maxlength="6"
                        class="w-full py-4 text-center bg-slate-800/50 border border-slate-700 rounded-xl text-2xl font-mono tracking-[0.5em] text-white placeholder-slate-700 focus:outline-none focus:border-indigo-500 transition-all">
                 <p class="text-center text-xs text-indigo-400 mt-4 opacity-50">Dev Mode: use 123456</p>
            </div>

            <div id="verify-error" class="hidden bg-red-500/10 border border-red-500/20 text-red-400 text-sm p-4 rounded-xl"></div>

            <button onclick="verifyOTP()" id="btn-verify"
                    class="w-full py-3.5 bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white font-semibold rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-emerald-500/20">
                <span id="verify-text">Verify & Create Account</span>
                <i data-lucide="check-circle" class="w-4 h-4"></i>
            </button>
            
            <button onclick="goBack(4)" class="w-full text-slate-500 hover:text-white text-sm py-2">Change phone number</button>
        </div>
    </div>

    <!-- Footer Links -->
    <div class="mt-8 text-center">
        <p class="text-slate-400 text-sm">
            Already have an account? <a href="{% url 'frontend:unified-login' %}" class="text-indigo-400 hover:text-indigo-300 font-medium transition-colors">Log In</a>
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // CSRF token
    function getCSRF() {
        return document.cookie.split(';').map(c => c.trim()).find(c => c.startsWith('csrftoken='))?.split('=')[1] || '';
    }

    // Init Lucide
    lucide.createIcons();
    
    // Auto-show step 1 on load
    document.addEventListener("DOMContentLoaded", () => {
        showStep(1);
    });

    let usernameTimer = null;
    let usernameAvailable = null;
    let userHasEditedUsername = false;

    function suggestUsername() {
        if (userHasEditedUsername) return; 
        const name = document.getElementById('owner_name').value.trim().toLowerCase();
        const gym = document.getElementById('gym_name').value.trim().toLowerCase();
        const first = name.split(/\s+/)[0]?.replace(/[^a-z0-9]/g, '') || '';
        const gymSlug = gym.split(/\s+/)[0]?.replace(/[^a-z0-9]/g, '') || '';
        if (first && gymSlug) {
            const suggestion = (first + '_' + gymSlug).substring(0, 25);
            document.getElementById('username').value = suggestion;
            checkUsername(suggestion);
        }
    }

    function onUsernameInput(el) {
        userHasEditedUsername = true;
        el.value = el.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
        const val = el.value;
        clearTimeout(usernameTimer);
        const icon = document.getElementById('username-icon');
        const status = document.getElementById('username-status');

        if (val.length === 0) {
            icon.classList.add('hidden');
            status.textContent = '';
            return;
        }

        if (val.length < 4) {
            icon.textContent = '';
            status.textContent = 'Minimum 4 characters';
            status.className = 'text-xs mt-1.5 h-4 text-amber-400';
            usernameAvailable = false;
            return;
        }

        icon.classList.remove('hidden');
        status.textContent = 'Checking...';
        status.className = 'text-xs mt-1.5 h-4 text-slate-400';
        usernameTimer = setTimeout(() => checkUsername(val), 300);
    }

    async function checkUsername(username) {
        const icon = document.getElementById('username-icon');
        const status = document.getElementById('username-status');
        const input = document.getElementById('username');

        try {
            const formData = new FormData();
            formData.append('username', username);
            const res = await fetch('/signup/check-username/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRF() },
                body: formData,
            });
            const data = await res.json();
            if (input.value.toLowerCase() !== username) return;

            icon.classList.remove('hidden');
            if (data.available) {
                icon.textContent = '✅';
                status.textContent = 'Available';
                status.className = 'text-xs mt-1.5 h-4 text-emerald-400';
                input.style.borderColor = '#10b981';
                usernameAvailable = true;
            } else {
                icon.textContent = '❌';
                status.textContent = data.message || 'Not available';
                status.className = 'text-xs mt-1.5 h-4 text-red-400';
                input.style.borderColor = '#ef4444';
                usernameAvailable = false;
            }
        } catch {
            status.textContent = 'Error checking';
        }
    }

    function toggleSignupPw() {
        const pw = document.getElementById('signup_password');
        pw.type = pw.type === 'password' ? 'text' : 'password';
    }

    function showStep(n) {
        // We have 5 logical steps, but dot progress is 4 dots max (Step 5 uses dot 4).
        [1, 2, 3, 4, 5].forEach(i => {
            const stepDiv = document.getElementById('step-' + i);
            if (stepDiv) stepDiv.classList.toggle('hidden', i !== n);
            
            const dotIdx = i === 5 ? 4 : i; // map step 5 -> dot 4
            const dot = document.getElementById('dot-' + dotIdx);
            if (!dot) return;
            
            if (n === dotIdx || (n === 5 && dotIdx === 4)) {
                 dot.className = 'step-dot active w-3 h-3 rounded-full bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)] transition-all';
            } else if (n > dotIdx) {
                 dot.className = 'step-dot w-3 h-3 rounded-full bg-emerald-500 transition-all'; 
            } else {
                 dot.className = 'step-dot w-3 h-3 rounded-full bg-slate-800 transition-all';
            }
        });
    }

    function goToStep2() {
        const selectedPlan = document.querySelector('input[name="plan_slug"]:checked');
        if (!selectedPlan) {
             alert("Please select a plan to continue.");
             return;
        }
        showStep(2);
    }

    function goToStep3() {
        const gymName = document.getElementById('gym_name').value.trim();
        const city = document.getElementById('city').value.trim();
        if (!gymName) {
            alert("Gym Name is required");
            return;
        }
        showStep(3);
    }

    function goToStep4() {
        const ownerName = document.getElementById('owner_name').value.trim();
        const email = document.getElementById('email').value.trim();
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('signup_password').value;

        if (!ownerName || !email || !username || !password) {
            alert("Please fill all fields");
            return;
        }
        showStep(4);
    }

    function goBack(n) {
        showStep(n);
    }

    async function sendOTP() {
        const phone = document.getElementById('phone').value.trim();
        if (phone.length !== 10) { alert('Invalid phone'); return; }

        const btn = document.getElementById('btn-send-otp');
        btn.disabled = true;
        btn.innerHTML = 'Sending...';

        const formData = new FormData();
        const selectedPlan = document.querySelector('input[name="plan_slug"]:checked').value;
        formData.append('plan_slug', selectedPlan);
        formData.append('gym_name', document.getElementById('gym_name').value.trim());
        formData.append('owner_name', document.getElementById('owner_name').value.trim());
        formData.append('email', document.getElementById('email').value.trim());
        formData.append('city', document.getElementById('city').value.trim());
        formData.append('phone', phone);
        formData.append('username', document.getElementById('username').value.trim().toLowerCase());
        formData.append('password', document.getElementById('signup_password').value);

        try {
            const res = await fetch('/signup/send-otp/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRF() },
                body: formData,
            });
            const data = await res.json();
            if (data.success) {
                document.getElementById('show-phone').textContent = '+91 ' + phone;
                showStep(5);
            } else {
                document.getElementById('otp-error').textContent = JSON.stringify(data.errors);
                document.getElementById('otp-error').classList.remove('hidden');
            }
        } catch (e) {
            alert('Error sending OTP');
        }
        btn.disabled = false;
        btn.innerHTML = 'Send OTP <i data-lucide="send" class="w-4 h-4"></i>';
        lucide.createIcons();
    }

    async function verifyOTP() {
        const otp = document.getElementById('otp').value.trim();
        if (otp.length !== 6) { alert('Invalid OTP'); return; }

        const btn = document.getElementById('btn-verify');
        btn.disabled = true;
        btn.textContent = 'Verifying...';

        const formData = new FormData();
        formData.append('otp', otp);

        try {
            const res = await fetch('/signup/verify-otp/', {
                 method: 'POST',
                 headers: { 'X-CSRFToken': getCSRF() },
                 body: formData,
            });
            const data = await res.json();
            if (data.success) {
                 window.location.href = data.redirect || '/dashboard/';
            } else {
                 document.getElementById('verify-error').textContent = data.error;
                 document.getElementById('verify-error').classList.remove('hidden');
            }
        } catch (e) {
            alert('Error verifying');
        }
        btn.disabled = false;
        btn.textContent = 'Verify & Create Account';
    }
</script>
{% endblock %}
