{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start Free Trial | GymAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: #0f172a; }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(99, 102, 241, 0.15);
        }

        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .float-anim { animation: float 6s ease-in-out infinite; }

        .step-dot { transition: all 0.3s ease; }
        .step-dot.active { background: #6366f1; box-shadow: 0 0 12px rgba(99, 102, 241, 0.5); }
        .step-dot.done { background: #22c55e; }

        .field-error { border-color: #ef4444 !important; }
        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }

        input:focus { box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.4); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4 py-8">
    <!-- Background orb -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-indigo-600/10 rounded-full blur-3xl float-anim"></div>
        <div class="absolute bottom-1/4 right-1/4 w-80 h-80 bg-violet-600/10 rounded-full blur-3xl float-anim" style="animation-delay: -3s;"></div>
    </div>

    <div class="relative z-10 w-full max-w-md">
        <!-- Logo -->
        <div class="text-center mb-8">
            <a href="/" class="inline-flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm mb-6">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to Home
            </a>
            <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center mb-4 shadow-lg shadow-indigo-500/25">
                <svg class="w-9 h-9 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-white">Start Your Free Trial</h1>
            <p class="text-slate-400 mt-1 text-sm">14 days free. No credit card required.</p>
        </div>

        <!-- Progress Steps -->
        <div class="flex items-center justify-center gap-3 mb-6">
            <div id="dot-1" class="step-dot active w-3 h-3 rounded-full"></div>
            <div class="w-8 h-px bg-slate-700"></div>
            <div id="dot-2" class="step-dot w-3 h-3 rounded-full bg-slate-700"></div>
            <div class="w-8 h-px bg-slate-700"></div>
            <div id="dot-3" class="step-dot w-3 h-3 rounded-full bg-slate-700"></div>
        </div>
        <p id="step-label" class="text-center text-xs text-slate-500 mb-4">Step 1 of 3 — Gym Details</p>

        <!-- Card -->
        <div class="glass-card rounded-2xl p-6 shadow-xl">

            <!-- Step 1: Gym Details -->
            <div id="step-1" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Gym Name *</label>
                    <input type="text" id="gym_name" placeholder="e.g. FitZone Gym"
                           oninput="suggestUsername()"
                           class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none transition-all" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Your Name *</label>
                    <input type="text" id="owner_name" placeholder="e.g. Rahul Sharma"
                           oninput="suggestUsername()"
                           class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none transition-all" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Email Address *</label>
                    <input type="email" id="email" placeholder="you@example.com"
                           class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none transition-all" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">City</label>
                    <input type="text" id="city" placeholder="e.g. Jaipur"
                           class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none transition-all">
                </div>

                <!-- Username with real-time check -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Username *</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-medium">@</span>
                        <input type="text" id="username" placeholder="choose_a_username"
                               oninput="onUsernameInput(this)"
                               class="w-full pl-9 pr-10 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none transition-all" required>
                        <!-- Status icon -->
                        <span id="username-icon" class="absolute right-3 top-1/2 -translate-y-1/2 text-lg hidden"></span>
                    </div>
                    <p id="username-status" class="text-xs mt-1.5 h-4"></p>
                </div>

                <!-- Password -->
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Password *</label>
                    <div class="relative">
                        <input type="password" id="signup_password" placeholder="Min 6 characters"
                               class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none transition-all pr-12" required>
                        <button type="button" onclick="toggleSignupPw()"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-200 transition-colors">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <button onclick="goToStep2()" id="btn-step1"
                        class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold
                               rounded-xl transition-all duration-200 flex items-center justify-center gap-2 mt-2">
                    Continue
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                    </svg>
                </button>
            </div>

            <!-- Step 2: Phone Number -->
            <div id="step-2" class="space-y-4 hidden">
                <div class="text-center mb-2">
                    <p class="text-sm text-slate-400">Verify your phone to create <span id="show-gym-name" class="text-white font-semibold"></span></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Phone Number *</label>
                    <div class="flex items-center gap-2">
                        <span class="px-3 py-3 bg-slate-800 border border-slate-700 rounded-xl text-slate-400 text-sm font-medium">+91</span>
                        <input type="tel" id="phone" placeholder="Enter 10-digit number"
                               maxlength="10" pattern="[0-9]{10}"
                               class="flex-1 px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none transition-all" required>
                    </div>
                </div>

                <div id="otp-error" class="hidden bg-red-500/10 border border-red-500/30 text-red-400 text-sm px-4 py-3 rounded-xl"></div>

                <button onclick="sendOTP()" id="btn-send-otp"
                        class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold
                               rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
                    <span id="send-otp-text">Send OTP</span>
                    <svg id="send-otp-spinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </button>

                <button onclick="goBack(1)" class="w-full text-center text-sm text-slate-500 hover:text-slate-300 transition-colors">
                    ← Back to gym details
                </button>
            </div>

            <!-- Step 3: OTP Verify -->
            <div id="step-3" class="space-y-4 hidden">
                <div class="text-center mb-2">
                    <p class="text-sm text-slate-400">Enter the OTP sent to <span id="show-phone" class="text-white font-mono"></span></p>
                    <p class="text-xs text-indigo-400 mt-1">Dev mode: use <span class="font-mono">123456</span></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">OTP Code</label>
                    <input type="text" id="otp" placeholder="Enter 6-digit OTP"
                           maxlength="6" pattern="[0-9]{6}"
                           class="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white text-center text-lg font-mono tracking-widest placeholder-slate-500 focus:outline-none transition-all" required>
                </div>

                <div id="verify-error" class="hidden bg-red-500/10 border border-red-500/30 text-red-400 text-sm px-4 py-3 rounded-xl"></div>

                <button onclick="verifyOTP()" id="btn-verify"
                        class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold
                               rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
                    <span id="verify-text">Create Account</span>
                    <svg id="verify-spinner" class="hidden animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                </button>

                <button onclick="goBack(2)" class="w-full text-center text-sm text-slate-500 hover:text-slate-300 transition-colors">
                    ← Change phone number
                </button>
            </div>
        </div>

        <!-- Footer -->
        <p class="text-center text-slate-600 text-xs mt-6">
            Already have an account? <a href="/login/" class="text-indigo-400 hover:text-indigo-300">Login here</a>
        </p>
    </div>

    <script>
        // CSRF token
        function getCSRF() {
            return document.cookie.split(';').map(c => c.trim()).find(c => c.startsWith('csrftoken='))?.split('=')[1] || '';
        }

        // ── Username: Real-time check (Instagram-style) ──
        let usernameTimer = null;
        let usernameAvailable = null;
        let userHasEditedUsername = false;

        function suggestUsername() {
            if (userHasEditedUsername) return; // Don't overwrite user's own choice
            const name = document.getElementById('owner_name').value.trim().toLowerCase();
            const gym = document.getElementById('gym_name').value.trim().toLowerCase();
            const first = name.split(/\s+/)[0]?.replace(/[^a-z0-9]/g, '') || '';
            const gymSlug = gym.split(/\s+/)[0]?.replace(/[^a-z0-9]/g, '') || '';
            if (first && gymSlug) {
                const suggestion = (first + '_' + gymSlug).substring(0, 25);
                document.getElementById('username').value = suggestion;
                checkUsername(suggestion);
            }
        }

        function onUsernameInput(el) {
            userHasEditedUsername = true;
            // Lowercase + strip invalid chars as user types
            el.value = el.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
            const val = el.value;

            clearTimeout(usernameTimer);

            const icon = document.getElementById('username-icon');
            const status = document.getElementById('username-status');

            if (val.length === 0) {
                icon.classList.add('hidden');
                status.textContent = '';
                usernameAvailable = null;
                return;
            }

            if (val.length < 4) {
                icon.classList.remove('hidden');
                icon.textContent = '⚠️';
                status.textContent = 'Minimum 4 characters';
                status.className = 'text-xs mt-1.5 h-4 text-amber-400';
                usernameAvailable = false;
                return;
            }

            // Show checking indicator
            icon.classList.remove('hidden');
            icon.textContent = '⏳';
            status.textContent = 'Checking...';
            status.className = 'text-xs mt-1.5 h-4 text-slate-400';

            // Debounce: 300ms
            usernameTimer = setTimeout(() => checkUsername(val), 300);
        }

        async function checkUsername(username) {
            const icon = document.getElementById('username-icon');
            const status = document.getElementById('username-status');
            const input = document.getElementById('username');

            try {
                const formData = new FormData();
                formData.append('username', username);
                const res = await fetch('/signup/check-username/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCSRF() },
                    body: formData,
                });
                const data = await res.json();

                // Only update if input value still matches (avoid race conditions)
                if (input.value.toLowerCase() !== username) return;

                icon.classList.remove('hidden');
                if (data.available) {
                    icon.textContent = '✅';
                    status.textContent = 'Available';
                    status.className = 'text-xs mt-1.5 h-4 text-emerald-400';
                    input.classList.remove('field-error');
                    input.style.borderColor = '#10b981';
                    usernameAvailable = true;
                } else {
                    icon.textContent = '❌';
                    status.textContent = data.message || 'Not available';
                    status.className = 'text-xs mt-1.5 h-4 text-red-400';
                    input.style.borderColor = '#ef4444';
                    usernameAvailable = false;
                }
            } catch {
                icon.textContent = '⚠️';
                status.textContent = 'Could not check';
                status.className = 'text-xs mt-1.5 h-4 text-amber-400';
                usernameAvailable = null;
            }
        }

        function toggleSignupPw() {
            const pw = document.getElementById('signup_password');
            pw.type = pw.type === 'password' ? 'text' : 'password';
        }

        // Step navigation
        function showStep(n) {
            [1, 2, 3].forEach(i => {
                document.getElementById('step-' + i).classList.toggle('hidden', i !== n);
                const dot = document.getElementById('dot-' + i);
                dot.classList.remove('active', 'done');
                if (i < n) dot.classList.add('done');
                if (i === n) dot.classList.add('active');
                if (i > n) dot.className = 'step-dot w-3 h-3 rounded-full bg-slate-700';
            });
            const labels = ['Step 1 of 3 — Gym Details', 'Step 2 of 3 — Phone Verification', 'Step 3 of 3 — OTP Verification'];
            document.getElementById('step-label').textContent = labels[n - 1];
        }

        function goToStep2() {
            // Validate step 1
            const gymName = document.getElementById('gym_name').value.trim();
            const ownerName = document.getElementById('owner_name').value.trim();
            const email = document.getElementById('email').value.trim();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('signup_password').value;

            let valid = true;
            ['gym_name', 'owner_name', 'email', 'username', 'signup_password'].forEach(id => {
                const el = document.getElementById(id);
                const val = el.value.trim();
                if (!val) {
                    el.classList.add('field-error', 'shake');
                    setTimeout(() => el.classList.remove('shake'), 400);
                    valid = false;
                } else {
                    el.classList.remove('field-error');
                }
            });

            // Extra validation
            if (username && username.length < 4) {
                document.getElementById('username').classList.add('field-error', 'shake');
                setTimeout(() => document.getElementById('username').classList.remove('shake'), 400);
                valid = false;
            }
            if (password && password.length < 6) {
                document.getElementById('signup_password').classList.add('field-error', 'shake');
                setTimeout(() => document.getElementById('signup_password').classList.remove('shake'), 400);
                valid = false;
            }
            // Check if username is marked as unavailable
            if (usernameAvailable === false) {
                document.getElementById('username').classList.add('field-error', 'shake');
                setTimeout(() => document.getElementById('username').classList.remove('shake'), 400);
                valid = false;
            }

            if (!valid) return;

            document.getElementById('show-gym-name').textContent = gymName;
            showStep(2);
            document.getElementById('phone').focus();
        }

        function goBack(toStep) {
            showStep(toStep);
        }

        async function sendOTP() {
            const phone = document.getElementById('phone').value.trim();
            if (!phone || phone.length < 10) {
                document.getElementById('phone').classList.add('field-error', 'shake');
                setTimeout(() => document.getElementById('phone').classList.remove('shake'), 400);
                return;
            }
            document.getElementById('phone').classList.remove('field-error');

            // Show spinner
            document.getElementById('send-otp-text').textContent = 'Sending...';
            document.getElementById('send-otp-spinner').classList.remove('hidden');
            document.getElementById('btn-send-otp').disabled = true;

            const formData = new FormData();
            formData.append('gym_name', document.getElementById('gym_name').value.trim());
            formData.append('owner_name', document.getElementById('owner_name').value.trim());
            formData.append('email', document.getElementById('email').value.trim());
            formData.append('city', document.getElementById('city').value.trim());
            formData.append('phone', phone);
            formData.append('username', document.getElementById('username').value.trim().toLowerCase());
            formData.append('password', document.getElementById('signup_password').value);

            try {
                const res = await fetch('/signup/send-otp/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCSRF() },
                    body: formData,
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('show-phone').textContent = '+91 ' + phone;
                    showStep(3);
                    document.getElementById('otp').focus();
                } else {
                    const errorDiv = document.getElementById('otp-error');
                    const errors = data.errors || {};
                    const msg = Object.values(errors).join(' ');
                    errorDiv.textContent = msg || 'Something went wrong.';
                    errorDiv.classList.remove('hidden');

                    // Highlight fields with errors
                    Object.keys(errors).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) {
                            el.classList.add('field-error', 'shake');
                            setTimeout(() => el.classList.remove('shake'), 400);
                        }
                    });

                    // If gym detail errors, go back to step 1
                    if (errors.gym_name || errors.owner_name || errors.email || errors.username || errors.password) {
                        showStep(1);
                    }
                }
            } catch (e) {
                document.getElementById('otp-error').textContent = 'Network error. Please try again.';
                document.getElementById('otp-error').classList.remove('hidden');
            }

            // Reset button
            document.getElementById('send-otp-text').textContent = 'Send OTP';
            document.getElementById('send-otp-spinner').classList.add('hidden');
            document.getElementById('btn-send-otp').disabled = false;
        }

        async function verifyOTP() {
            const otp = document.getElementById('otp').value.trim();
            if (!otp || otp.length < 6) {
                document.getElementById('otp').classList.add('field-error', 'shake');
                setTimeout(() => document.getElementById('otp').classList.remove('shake'), 400);
                return;
            }
            document.getElementById('otp').classList.remove('field-error');

            // Show spinner
            document.getElementById('verify-text').textContent = 'Creating account...';
            document.getElementById('verify-spinner').classList.remove('hidden');
            document.getElementById('btn-verify').disabled = true;

            const formData = new FormData();
            formData.append('otp', otp);

            try {
                const res = await fetch('/signup/verify-otp/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCSRF() },
                    body: formData,
                });
                const data = await res.json();

                if (data.success) {
                    // Cache gym info in localStorage
                    if (data.gym_cache) {
                        localStorage.setItem('gymai_gym_cache', JSON.stringify(data.gym_cache));
                    }
                    window.location.href = data.redirect || '/dashboard/';
                } else {
                    const errorDiv = document.getElementById('verify-error');
                    errorDiv.textContent = data.error || 'Invalid OTP.';
                    errorDiv.classList.remove('hidden');
                    document.getElementById('otp').classList.add('field-error');
                }
            } catch (e) {
                document.getElementById('verify-error').textContent = 'Network error. Please try again.';
                document.getElementById('verify-error').classList.remove('hidden');
            }

            // Reset button
            document.getElementById('verify-text').textContent = 'Create Account';
            document.getElementById('verify-spinner').classList.add('hidden');
            document.getElementById('btn-verify').disabled = false;
        }

        // On Enter key, proceed to the next step
        document.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter') return;
            const s1 = !document.getElementById('step-1').classList.contains('hidden');
            const s2 = !document.getElementById('step-2').classList.contains('hidden');
            const s3 = !document.getElementById('step-3').classList.contains('hidden');
            if (s1) goToStep2();
            else if (s2) sendOTP();
            else if (s3) verifyOTP();
        });
    </script>
</body>
</html>
